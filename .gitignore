### IntelliJ IDEA ###
out/
!**/src/main/**/out/
!**/src/test/**/out/

### Eclipse ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache
bin/
!**/src/main/**/bin/
!**/src/test/**/bin/

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/

### VS Code ###
.vscode/

### Mac OS ###
.DS_Store



from PyQt6.QtWidgets import (
    QMainWindow, QWidget, QVBoxLayout, QHBoxLayout, QSplitter,
    QFileDialog, QLineEdit, QTableView, QTabWidget,
    QPushButton,  QFrame, QLabel, QMessageBox, QComboBox, QInputDialog, QAbstractItemView, QDialog
)
from PyQt6.QtGui import QAction, QIcon, QDesktopServices
from PyQt6.QtCore import Qt, QTimer, QUrl, QCoreApplication
import pandas as pd
import json
import os
import sys
from datetime import datetime
from windows.DetailsWindow import DetailsWindow
from windows.AddItemWindow import AddItemWindow
from windows.EditStorageAmountWindow import EditStorageAmountWindow
from windows.AssetAssignmentWindow import AssetAssignmentWindow
from windows.LogWindow import LogWindow
from windows.ProceduresWindow import ProceduresWindow
from windows.ConnectorDefinitionWindow import ConnectorDefinitionWindow
from windows.BackshellDefinitionWindow import BackshellDefinitionWindow
from windows.DataFrameModel import DataFrameModel
from windows.FilterProxyModel import FilterProxyModel
from utils.ExcelUtils import load_excel_data, save_excel
from utils.DataFrameUtils import find_extra_row_value, get_definition_and_changes
from utils.ActionButtonsDelegate import ActionButtonsDelegate

class MainWindow(QMainWindow):
    """ Ana pencereyi temsil eden sÄ±nÄ±f. UygulamanÄ±n ana arayÃ¼zÃ¼nÃ¼ oluÅŸturur. """

    def __init__(self):
        super().__init__()
        #self.setWindowIcon(QIcon("assets/tai_logo.svg"))
        self.setWindowTitle("TUSAS-Envanter")
        self.resize(1000, 700)
        self.tab_contexts={}

        self.MAX_UNDO_STEPS = 5

        self.df = pd.DataFrame()

        self.selected_item = None
        self.selected_row = None
        self.selected_column = None

        self.current_theme = "light"
        self.isLogAvailable = False
        self.log_lines = []
        self.log_filepath = None

        self.table_view = None
        self.data_model = None
        self.proxy_model = None

        self.auto_save_timer = QTimer(self)
        self.auto_save_timer.timeout.connect(self.auto_save_all_tabs)
        self.AUTO_SAVE_INTERVAL_MS = 300000 
        self.auto_save_timer.start(self.AUTO_SAVE_INTERVAL_MS)

        self.procedure_description = ""
        self.last_change_id = 0

        self.action_delegate = ActionButtonsDelegate(self.table_view)
        self.action_delegate.buttonClicked.connect(self.handle_action_click)

        self.initial_filepath_config = os.path.abspath(f"./data/filepath_config.json")
        self.file_paths = self.load_file_paths(self.initial_filepath_config)        
       

        if self.file_paths:
            self.log_filepath = self.get_file_path("log_filepath")
            self.read_log_file(self.log_filepath)

        if self.file_paths:
            initial_header_filepath = self.get_file_path("header_config_filepath")
            self.json_data = self.load_json_data(initial_header_filepath)
        else:
            self.json_data = None
            
        if self.file_paths:
            self.options_config_filepath = self.get_file_path("options_config_filepath")
            
        self.init_ui()

    
    def edit_procedure_description(self, description):
        self.procedure_description = description

    def init_ui(self):
        """ KullanÄ±cÄ± arayÃ¼zÃ¼ bileÅŸenlerini baÅŸlatÄ±r ve dÃ¼zenler.
            Ana dÃ¼zeni, menÃ¼leri, sekmeleri ve alt bilgi bileÅŸenlerini oluÅŸturur.
        """
        central_widget = QWidget()
        self.setCentralWidget(central_widget)

        self.update_theme()
        
        self.main_layout = QVBoxLayout(central_widget)
        self.main_layout.setSpacing(0)
        self.main_layout.setContentsMargins(0, 0, 0, 0)
        
        self.init_menu()
        self.init_tabs()
        self.init_footer()

        if self.file_paths:
            initial_excel_filepath = self.get_file_path("excel_filepath")
            self.open_default_file(initial_excel_filepath)

    def init_menu(self):
        """ UygulamanÄ±n menÃ¼ Ã§ubuÄŸunu oluÅŸturur ve gerekli menÃ¼leri ile eylemleri tanÄ±mlar ve birbirine baÄŸlar.
            MenÃ¼ler arasÄ±nda 'Dosya', 'GÃ¶rÃ¼nÃ¼m' ve 'YardÄ±m' menÃ¼leri bulunur.
        """
        menu_bar = self.menuBar()

        file_menu = menu_bar.addMenu("Dosya")
        
        select_file_action = QAction("Dosya seÃ§", self)
        select_file_action.triggered.connect(self.select_file)
        file_menu.addAction(select_file_action)

        save_current_file_action = QAction("DosyayÄ± Kaydet", self)
        save_current_file_action.triggered.connect(self.save_current_file)
        file_menu.addAction(save_current_file_action)

        save_file_action = QAction("DosyayÄ± farklÄ± kaydet", self)
        save_file_action.triggered.connect(self.save_to_excel)
        file_menu.addAction(save_file_action)
        
        # KayÄ±t Bilgileri MenÃ¼sÃ¼
        log_menu = menu_bar.addMenu("KayÄ±t Bilgileri")
        show_log_action = QAction("KayÄ±t bilgilerini gÃ¶rÃ¼ntÃ¼le", self)
        show_log_action.setEnabled(self.isLogAvailable)
        show_log_action.triggered.connect(self.show_log_for_all_items)
        log_menu.addAction(show_log_action)
        
        # GÃ¶rÃ¼nÃ¼m MenÃ¼sÃ¼
        view_menu = menu_bar.addMenu("GÃ¶rÃ¼nÃ¼m")
        increase_screen_size_action = QAction("BÃ¼yÃ¼t", self)
        increase_screen_size_action.triggered.connect(self.increase_screen_size)
        view_menu.addAction(increase_screen_size_action)

        decrease_screen_size_action = QAction("KÃ¼Ã§Ã¼lt", self)
        decrease_screen_size_action.triggered.connect(self.decrease_screen_size)
        view_menu.addAction(decrease_screen_size_action)

        theme_toggle_action = QAction("Tema DeÄŸiÅŸtir", self)
        theme_toggle_action.triggered.connect(self.toggle_theme)
        view_menu.addAction(theme_toggle_action)

        # YardÄ±m MenÃ¼sÃ¼
        help_menu = menu_bar.addMenu("YardÄ±m")
        
        ask_for_help_action = QAction("YardÄ±m al", self)
        ask_for_help_action.triggered.connect(self.open_help_website)
        help_menu.addAction(ask_for_help_action)


    def init_tabs(self):
        """ Sekme bileÅŸenlerini baÅŸlatÄ±r ve yargÄ±landÄ±rÄ±r.
        """
        self.tab_widget = QTabWidget()
        self.tab_widget.tabCloseRequested.connect(self.close_tab)
        self.tab_widget.currentChanged.connect(self.switch_tab)
        self.main_layout.addWidget(self.tab_widget)
        self.tab_contexts = {}
        
    def open_default_file(self, file_path):
        """ VarsayÄ±lan dosyayÄ± aÃ§an fonksiyon. """
        
        if file_path:
            file_name = os.path.basename(file_path)
            
            df = self.open_file_with_draft_check(file_path)
            if df is not None:
                df = df.astype(str)
                cleaned_data = []
                for _, row in df.iterrows():
                    if not all(value == "" or value == "nan" for value in row):
                        cleaned_row=row.replace({"nan":""})
                        #cleaned_data.append(cleaned_row)
                        if not all(value == "" for value in cleaned_row):
                            cleaned_data.append(cleaned_row)
                cleaned_df = pd.DataFrame(cleaned_data, columns=df.columns)
                self.init_content(file_name, cleaned_df, file_path)

    def load_json_data(self, file_path):
        """ Belirtilen dosya yolundaki JSON dosyasÄ±nÄ± yÃ¼kler. """
        
        file_name = os.path.basename(file_path)
        
        try:
            with open(file_path, 'r', encoding='utf-8') as json_file:
                return json.load(json_file)
        except Exception as e:
            QMessageBox.warning(self, "UyarÄ±", f"{file_name} dosyasÄ± okunamadÄ±: {str(e)}")
            return None

    def load_options(self, file_path):
        """ Malzeme Ã¶zelliklerinin comboboxlarÄ±nÄ± tanÄ±mlayan JSON dosyasÄ±nÄ± yÃ¼kler. """
        
        options_config_filepath = self.get_file_path("options_config_filepath")
        if not options_config_filepath:
            QMessageBox.critical(self, "Hata", f"Dosya yolu bulunamadÄ±: '{options_config_filepath}'")
            return None

        try:
            with open(options_config_filepath, 'r', encoding='utf-8') as f:
                return json.load(f)
        except Exception as e:
            QMessageBox.warning(self, "UyarÄ±", f"Combobox dosyasÄ± okunamadÄ±: {str(e)}")
            return {None}

    def read_log_file(self, filepath):
        try:
            with open(filepath, 'r', encoding='utf-8') as file:
                for line in file:
                    log_line = line.strip()
                    is_saved = True
                    filepath = ""
                    self.log_lines.append({"log_line": log_line, "is_saved": is_saved, "filepath": filepath, "change_id":None, "iS_activate":None})
            self.isLogAvailable = True
        except Exception as e:
            QMessageBox.warning(self, "UyarÄ±", f"Combobox dosya okunamadÄ±: {str(e)}")

    def init_content(self, file_name, df, file_path):

        df = df.astype(str)#!!!!! self vardÄ±
        content_widget = QWidget()
        content_layout = QVBoxLayout(content_widget)
        content_layout.setContentsMargins(10, 10, 10, 10)

        # Filtreleme combobox'u ve arama Ã§ubuÄŸu iÃ§in yatay layout
        filter_search_layout = QHBoxLayout()
        filter_search_layout.setContentsMargins(0, 0, 0, 0)
        filter_search_layout.setSpacing(6)

        # Filtreleme combobox'u ve arama Ã§ubuÄŸu
        filter_combo = QComboBox()
        filter_combo.addItems(df.columns.tolist())
        filter_combo.addItems(["KonnektÃ¶rler"])
        filter_search_layout.addWidget(filter_combo)

        
        search_bar = QLineEdit()
        search_bar.setPlaceholderText("Ara...")

        search_bar.textChanged.connect(self.update_row_filters)
        filter_search_layout.addWidget(search_bar)
        
        filter_combo.currentTextChanged.connect(self.update_row_filters)
        filter_search_widget = QWidget()
        filter_search_widget.setLayout(filter_search_layout)

        
        # Kategori aÃ§Ä±lÄ±r menÃ¼sÃ¼
        category_combo = QComboBox()
        category_combo.setStyleSheet("background-color: #e17100; color: white;")        
        if self.json_data:
            category_combo.addItems(self.json_data.keys())
        category_combo.currentTextChanged.connect(self.on_category_changed)
        content_layout.addWidget(category_combo)

        # Ekle butonu
        add_button = QPushButton("Tedarik Ekle")
        add_button.setStyleSheet("background-color: #15803d; color: white;")
        
        content_layout.addWidget(add_button)
        
        # Malzeme ekle butonu
        add_material_button = QPushButton("Malzeme Ekle")
        add_material_button.setStyleSheet("background-color: #15803d; color: white;")
        
        content_layout.addWidget(add_material_button)
        
        # Geri Al ve Yinele dÃ¼ÄŸmeleri ve Kaydet butonu
        
        # Geri Al butonu (sol tarafa)
        undo_button = QPushButton("â†¶")
        undo_button.setStyleSheet("background-color: #15803d; color: white;")
        undo_button.setFixedSize(25, 25)
        undo_button.setToolTip("Geri Al (Ctrl+Z)")
        undo_button.clicked.connect(self.undo_changes)
        content_layout.addWidget(undo_button)

        # Yinele butonu
        redo_button = QPushButton("â†·")
        redo_button.setStyleSheet("background-color: #15803d; color: white;")
        redo_button.setFixedSize(25, 25)
        redo_button.setToolTip("Yinele (Ctrl+Y)")
        redo_button.clicked.connect(self.redo_changes)
        content_layout.addWidget(redo_button)
        
        # Kaydet butonu (sol tarafa)
        save_button = QPushButton("ğŸ’¾")
        save_button.setStyleSheet("background-color: #3498db; color: white;")
        save_button.setFixedSize(25, 25)
        save_button.setToolTip("Kaydet (Ctrl+S)")
        save_button.clicked.connect(self.save_current_file)
        
        # Buton ve arama Ã§ubuÄŸu iÃ§in yatay layout
        button_layout = QHBoxLayout()
        button_layout.addWidget(category_combo,1)
        button_layout.addWidget(add_button,1)
        button_layout.addWidget(add_material_button,1)
        button_layout.addWidget(filter_search_widget,18)
        button_layout.addWidget(undo_button,1)
        button_layout.addWidget(redo_button,1)
        button_layout.addWidget(save_button,1)
        content_layout.addLayout(button_layout)
        
        # QSplitter oluÅŸturma
        splitter = QSplitter(Qt.Orientation.Vertical)

        # Content and Table
        table_view = QTableView()
        table_view.horizontalHeader().setDefaultAlignment(Qt.AlignmentFlag.AlignLeft)

        splitter.addWidget(table_view)
        
        # QSplitter'a tablo ekleme
        data_model = DataFrameModel(df)
        proxy_model = FilterProxyModel(self)
        proxy_model.setSourceModel(data_model)
        table_view.setModel(proxy_model)
        
        # Bilgilendirme kÄ±smÄ±
        info_frame = QFrame()
        info_frame.setStyleSheet("background-color: #e0e0e0; border: 1px solid #ccc;")
        info_layout = QVBoxLayout(info_frame)
        info_label = QLabel()
        info_layout.addWidget(info_label)
        info_frame.setVisible(False)

        # Kapatma butonu
        close_button = QPushButton("x")
        close_button.setStyleSheet("background-color: transparent; color: red; border: none;")
        close_button.clicked.connect(lambda: self.close_info(info_frame))
        
        button_layout = QHBoxLayout()
        button_layout.addWidget(close_button, alignment=Qt.AlignmentFlag.AlignRight)
        info_layout.addLayout(button_layout)
        info_frame.setVisible(False)
        
        # QSplitter'a info frame ekleme
        splitter.addWidget(info_frame)
        content_layout.addWidget(splitter)

        # DÃ¼zenleme Ã§ubuÄŸu
        cell_edit_input = QLineEdit()
        cell_edit_input.setPlaceholderText("DÃ¼zenlemek iÃ§in bir hÃ¼cre seÃ§in...")
        cell_edit_input.setEnabled(False)
        content_layout.addWidget(cell_edit_input)
        table_view.selectionModel().currentChanged.connect(lambda index: self.handle_cell_clicked(index.row(), index.column(), info_label, info_frame))
        cell_edit_input.editingFinished.connect(self.update_cell_value)

        # ilgili tab iÃ§in tek seferlik baÅŸlangÄ±Ã§ ayarlarÄ±
        self.tab_widget.addTab(content_widget, file_name)
        self.tab_widget.setCurrentIndex(self.tab_widget.count() - 1)

        has_valid_headers = True
        if not all(col in df.columns for col in df):
            has_valid_headers = False

        category_combo.setEnabled(has_valid_headers)
        add_material_button.setEnabled(has_valid_headers)

        if has_valid_headers and self.json_data:
            category_combo.setCurrentIndex(1)
        else:
            category_combo.setCurrentIndex(0)
            
        self.tab_contexts[file_name] = {
            'df': df,
            'last_saved_df': df.copy(),
            'undo_history': [[]],
            'history_index': 0,
            'df_index_map': [],
            'table_view': table_view,
            'data_model': data_model,
            'proxy_model': proxy_model,
            'search': search_bar,
            'filter_combo': filter_combo,
            'cell_edit_input': cell_edit_input,
            'category': category_combo,
            'info_label': info_label,
            'info_frame': info_frame,
            'has_valid_headers': has_valid_headers,
            'headers': [],
            'file_path': file_path
        }
        
        add_button.clicked.connect(lambda: self.open_add_item_window(self.tab_contexts[file_name]["df"], mode="element"))
        add_material_button.clicked.connect(lambda: self.open_add_item_window(self.tab_contexts[file_name]["df"], mode="material"))
        
        self.sync_current_tab_context(file_name)
        if self.category_combo.currentText():
            self.on_category_changed(category_combo.currentText(), do_not_update = False)
        
        else:
            self.update_table_from_df(change_type=None)


    def all_headers_exist_in_df(self, df):
        """
        JSON verisinde tanÄ±mlanan tÃ¼m baÅŸlÄ±klarÄ±n, verilen veri Ã§erÃ§evesinde mevcut olup olmadÄ±ÄŸÄ±nÄ± kontrol eder.

        Args:
            df (pd.DataFrame): Kontrol edilecek veri Ã§erÃ§evesi.

        Returns:
            bool: TÃ¼m baÅŸlÄ±klar mevcutsa True, aksi takdirde False dÃ¶ner.
        """
        df_columns = set(df.columns)  
        if not self.json_data:
            return False

        if "Teslim AlÄ±nan Miktar" in df.columns:
            if "Depo Miktar[Â°]" in df.columns:
                df["Depo Konumu"] = [""] * len(df)
            if "Depo Konumu" in df.columns:
                df["Depo Konumu"] = [""] * len(df)

        if not self.json_data:
            return True
        if "Malzeme Katalog Tarihi (TR)" in df.columns:
            return True
        else:
            return False

    def handle_cell_clicked(self, row, column, info_label, info_frame):
        """
        KullanÄ±cÄ±nÄ±n tablo hÃ¼cresine tÄ±kladÄ±ÄŸÄ±nda gerÃ§ekleÅŸen iÅŸlemleri yÃ¶netir.
        EÄŸer tÄ±klanan hÃ¼cre 'Ä°ÅŸlemler' sÃ¼tunundaysa, hiÃ§bir iÅŸlem yapmaz.
        Aksi takdirde, hÃ¼cre iÃ§eriÄŸini dÃ¼zenleme alanÄ±na yÃ¼kler ve ilgili bilgileri gÃ¶sterir.

        Args:
            row (int): TÄ±klanan hÃ¼crenin satÄ±r numarasÄ±.
            column (int): TÄ±klanan hÃ¼crenin sÃ¼tun numarasÄ±.
            info_label (QLabel): Bilgi etiketini gÃ¼ncellemek iÃ§in kullanÄ±lan QLabel.
            info_frame (QFrame): Bilgi Ã§erÃ§evesini gÃ¶stermek iÃ§in kullanÄ±lan QFrame.
        """
        current_tab = self.tab_widget.tabText(self.tab_widget.currentIndex())
        proxy_model = self.tab_contexts[current_tab]['proxy_model']
        cell_edit_input = self.tab_contexts[current_tab]['cell_edit_input']

        original_df_index = proxy_model.getOriginalRow(row)
        model_index = proxy_model.index(row, column)
        source_index = proxy_model.mapToSource(model_index)
        original_column_index = source_index.column() if source_index.isValid() else -1
        if original_column_index == -1:
            return

        value = proxy_model.data(model_index, Qt.ItemDataRole.DisplayRole)

        if model_index.isValid():
            self.selected_row = original_df_index
            self.selected_column = original_column_index
            str_value = str(value) if value is not None else ""
            cell_edit_input.setText(str_value)
            cell_edit_input.setEnabled(True)
            self.display_row_info(original_df_index, info_label, info_frame)
        else:
            self.cell_edit_input.clear()
            self.cell_edit_input.setEnabled(False)
            self.close_info()

    def display_row_info(self, display_index, info_label, info_frame):
        """
        Belirtilen satÄ±rdaki bilgileri gÃ¶steren fonksiyon.

        Args:
            row (int): GÃ¶sterilecek satÄ±rÄ±n indeksi.
            info_label (QLabel): Bilgi metnini gÃ¶sterecek etiket.
            info_frame (QFrame): Bilgi Ã§erÃ§evesi.
        """
        current_tab = self.tab_widget.tabText(self.tab_widget.currentIndex())
        df = self.tab_contexts[current_tab]['df']

        row_data = df.iloc[display_index]
        info_text = "".join([f"**{header}**: {row_data[header]} \n" for header in df.columns])
        info_label.setText(info_text)
        info_frame.setVisible(True)
        self.update_theme()

    def close_info(self, info_frame):
        """
        Args:
            info_frame (QFrame): KapatÄ±lacak bilgi Ã§erÃ§evesi.
        """
        if info_frame:
            info_frame.setVisible(False)

    def init_footer(self):
        """
        UygulamanÄ±n alt kÄ±smÄ±nÄ± baÅŸlatan fonksiyon.
        """
        copyright_frame = QFrame()
        copyright_frame.setStyleSheet("background-color: #1e3605;")
        copyright_layout = QHBoxLayout(copyright_frame)
        copyright_label = QLabel("Â© 2025. TÃ¼m haklarÄ± saklÄ±dÄ±r.")
        copyright_label.setStyleSheet("color: white; font-size: 12px;")
        copyright_layout.addWidget(copyright_label, alignment=Qt.AlignmentFlag.AlignCenter)
        self.main_layout.addWidget(copyright_frame)

    def close_tab(self, index):
        """
        Belirtilen sekmeyi kapatan fonksiyon.

        Args:
            index (int): KapatÄ±lacak sekmenin indeksi.
        """
        tab_name = self.tab_widget.tabText(index)
        if tab_name in self.tab_contexts:
            context = self.tab_contexts[tab_name]
            if not context['df'].equals(context['last_saved_df']):
                reply = QMessageBox(self)
                reply.setText(f"{tab_name} sekmesi kaydedilmemiÅŸ. Kaydetmek istiyor musunuz?")
                reply.setStandardButtons(QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No | QMessageBox.StandardButton.Cancel)
                reply_result = reply.exec()

                if reply_result == QMessageBox.StandardButton.Yes:
                    file_path = context['file_path']
                    df  = context['df']
                    success = save_excel(df,file_path)
                    
                    if success:
                        for log_entry in self.log_files:
                            if log_entry['file_path'] == file_path:
                                log_entry['is_saved'] = True
                        
                        self.save_log_lines_to_log_file()
                        context['last_saved_df'] = context['df'].copy()
                        draft_filepath = self.get_draft_filepath(file_path)
                        try:
                            os.remove(draft_filepath)
                        except Exception as e:
                            QMessageBox.critical(self, "Hata", f"Taslak silinirken hata: {e}")
                            
                    else:
                        QMessageBox.critical(self, "Hata", f"{tab_name} dosyasÄ± kaydedilemedi.")
                        return
                elif reply_result == QMessageBox.StandardButton.No:
                        pass

                elif reply_result == QMessageBox.StandardButton.Cancel:
                    return 

        self.tab_widget.removeTab(index)
        if tab_name in self.tab_contexts:
            del self.tab_contexts[tab_name]

        if self.tab_widget.count() == 0:
            self.df = pd.DataFrame()
            self.update_table_from_df(df,change_type=None)

        else:
            current_name = self.tab_widget.tabText(self.tab_widget.currentIndex())
            self.df = self.tab_contexts[current_name]['df']
            self.update_table_from_df(self.df, change_type=None)

    def switch_tab(self, index):
        """
        Sekmeler arasÄ±nda geÃ§iÅŸ yapan fonksiyon.

        Args:
            index (int): GeÃ§iÅŸ yapÄ±lacak sekmenin indeksi.
        """
        if index == -1:
            return

        tab_name = self.tab_widget.tabText(index)
        if tab_name in self.tab_contexts:
            self.sync_current_tab_context(tab_name)
            self.update_table_from_df(change_type=None)

    def sync_current_tab_context(self, tab_name):
        """
        geÃ§erli sekmenin baÄŸlamÄ±nÄ± senkronize eden fonksiyon.

        Args:
            tab_name (str): Senkronize edilecek sekmenin adÄ±.
        """
        context = self.tab_contexts.get(tab_name)
        if context:
            self.df = context['df']
            self.table_view = context['table_view']
            self.data_model = context['data_model']
            self.proxy_model = context['proxy_model']
            self.table_view.setModel(self.proxy_model)
            self.search_bar = context['search']
            self.cell_edit_input = context['cell_edit_input']
            self.category_combo = context['category']

    def open_file_with_draft_check(self, file_path):
        file_name = os.path.basename(file_path)
        draft_filepath = self.get_draft_filepath(file_path)
        df = None

        if os.path.exists(draft_filepath):
            reply = QMessageBox.question(self, "Taslak Bulundu",
                                         f"'{file_name}' dosyasÄ± iÃ§in kaydedilmemiÅŸ bir taslak bulundu. YÃ¼klemek istiyor musunuz?")
            if reply == QMessageBox.StandardButton.Yes:
                df = load_excel_data(draft_filepath)
                if df is None:
                    QMessageBox.warning(self, "Hata", "Taslak dosyasÄ± bozuk. Orijinal dosya yÃ¼klenecek.")
                    df = load_excel_data(file_path)
                else:
                    success_save = save_excel(df, file_path) # df tanÄ±mlÄ± deÄŸil.
                    if success_save: # 'success' deÄŸiÅŸkeni kontrol ediliyor
                        QMessageBox.information(self, "BaÅŸarÄ±lÄ±", "Taslak baÅŸarÄ±yla ana dosyaya kaydedildi.")
                        try:
                            os.remove(draft_filepath)
                        except Exception as e:
                            QMessageBox.critical(self, "Hata", f"Taslak silinirken hata: {e}")

                    elif reply == QMessageBox.StandardButton.No:
                        df = load_excel_data(file_path)
                        try:
                            os.remove(draft_filepath)
                        except Exception as e:
                            QMessageBox.critical(self, "Hata", f"Taslak silinirken hata: {e}")
        df = load_excel_data(file_path)


        if df is not None:
            df = df.astype(str)
            cleaned_data = []
            for index, row in df.iterrows():
                if not all(value == "" or value == "nan" for value in row):
                    cleaned_row = row.replace("nan", "")
                    cleaned_data.append(cleaned_row)
            cleaned_df = pd.DataFrame(cleaned_data, columns=df.columns)
            return cleaned_df

    def select_file(self):
        """
        KullanÄ±cÄ±dan bir dosya seÃ§mesini saÄŸlayan fonksiyon.
        SeÃ§ilen dosya bir Excel dosyasÄ± olmalÄ±dÄ±r.
        """
        file_path, _ = QFileDialog.getOpenFileName(self, "Dosya SeÃ§", "", "Excel DosyalarÄ± (*.xlsx *.xls)")

        if file_path:
            file_name = os.path.basename(file_path)
            df = load_excel_data(file_path)

            if df is not None:
                df = df.astype(str)
                cleaned_data = []
                for index, row in df.iterrows():
                    if not all(value == "" or value == "nan" for value in row):
                        cleaned_row = row.replace("nan", "")
                        cleaned_data.append(cleaned_row)
                cleaned_df = pd.DataFrame(cleaned_data, columns=df.columns)

                for existing_file_path in self.tab_contexts.values():
                    if existing_file_path['file_path'] == file_path:
                        QMessageBox.warning(self, "Hata", "Bu sekme zaten aÃ§Ä±k.")
                        return

                if file_name in self.tab_contexts:
                    new_file_path = file_path
                    self.tab_contexts[new_file_path] = self.tab_contexts.pop(file_name)
                    file_name = new_file_path

                self.init_content(file_name, cleaned_df, file_path)

    def open_help_website(self):
        """
        YardÄ±m ve destek web sitesini aÃ§an fonksiyon.
        """
        QDesktopServices.openUrl(QUrl("https://git.tai.com.tr/a09138"))

    def toggle_theme(self):
        """
        UygulamanÄ±n temasÄ±nÄ± deÄŸiÅŸtiren fonksiyon.
        Temalar arasÄ±nda geÃ§iÅŸ yapar: aÃ§Ä±k ve koyu.
        """
        if self.current_theme == "light":
            self.current_theme = "dark"
        else:
            self.current_theme = "light"
        self.update_theme()

    def update_theme(self):
        """
        UygulamanÄ±n temasÄ±nÄ± gÃ¼ncelleyen fonksiyon.
        Temaya gÃ¶re stil ayarlarÄ±nÄ± deÄŸiÅŸtirir.
        """
        if self.current_theme == "light":
            self.setStyleSheet("background-color: #f0f0f0; color: black;")
            if hasattr(self, 'tab_contexts'):
                for file_name, tab_context in self.tab_contexts.items():
                    if 'info_frame' in tab_context:
                        tab_context['info_frame'].setStyleSheet("background-color: #e0e0e0; border: 1px solid #ccc;")
        else:
            self.setStyleSheet("background-color: #2e2e2e; color: white;")
            if hasattr(self, 'tab_contexts'):
                for file_name, tab_context in self.tab_contexts.items():
                    if 'info_frame' in tab_context:
                        tab_context['info_frame'].setStyleSheet("background-color: #444; border: 1px solid #666;")


    def update_table_from_df(self, df=None, change_type=None):
        """
        DataFrame'den tabloyu gÃ¼ncelleyen fonksiyon.
        """
        current_file_name = self.tab_widget.tabText(self.tab_widget.currentIndex())
        tab_context = self.tab_contexts.get(current_file_name)
        
        if not tab_context:
            return
        
        table_view = tab_context.get('table_view')
        proxy_model = tab_context.get('proxy_model')
        data_model = tab_context.get('data_model')
        
        # Scroll pozisyonunu kaydet
        saved_scroll_position = table_view.verticalScrollBar().value()
        saved_current_row = table_view.currentIndex().row()
        
        if df is not None:
            tab_context['df'] = df
        else:
            df = tab_context['df']

        # Modeli gÃ¼ncelle
        data_model.update_df(df)
        
        if df.empty:
            return
        
        # BaÅŸlÄ±klarÄ± Belirle
        selected_category = tab_context['category'].currentText()
        if self.json_data and selected_category in self.json_data:
            json_headers = list(self.json_data[selected_category]) 
        else:
            json_headers = df.columns.tolist()
            
        final_headers = json_headers.copy()

        # "Ä°ÅŸlemler" sÃ¼tunu yoksa ekle
        if "Ä°ÅŸlemler" not in final_headers:
            final_headers.append("Ä°ÅŸlemler")

        # Proxy modele sÃ¼tunlarÄ± bildir (Tablo resetlenir)
        proxy_model.setColumnFilter(final_headers)
        proxy_model.setCategoryFilter(selected_category)
        
        # --- DELEGATE ATAMA KISMI ---
        self.refresh_action_delegate()
        # ---------------------------------------------------

        # --- SEÃ‡Ä°MÄ° GERÄ° YÃœKLE ---
        current_visible_row_count = proxy_model.rowCount()
        if change_type == "Sil" and saved_current_row != -1:
            saved_current_row = min(saved_current_row, current_visible_row_count - 1)
        elif change_type == "Ekle":
            saved_current_row = current_visible_row_count - 1
            
        if current_visible_row_count > 0 and saved_current_row >= 0:
            table_view.verticalScrollBar().setValue(saved_scroll_position)
            table_view.selectRow(saved_current_row)
    def handle_procedures(self, df, row_index):
        temp_df = df.copy()
        isAddStorageEnabled = True if df.get('Depo MiktarÄ±', None).iloc[row_index] == "" and df.get('Depo Konumu', None).iloc[row_index] == "" else False
        procedures_window = ProceduresWindow(df, row_index, isAddStorageEnabled, self)
        procedures_window.exec()
        self.apply_changes(temp_df, change_type="Procedures", description=self.procedure_description)

    def save_to_excel(self):
        """
        DataFrame'i bir Excel dosyasÄ±na kaydeden fonksiyon.
        EÄŸer kaydedilecek veri yoksa kullanÄ±cÄ±ya uyarÄ± verir.
        """
        if self.df.empty:
            QMessageBox.warning(self, "UyarÄ±", "Kaydedilecek veri yok.")
            return

        file_path, _ = QFileDialog.getSaveFileName(self, "Excel'e Kaydet", "", "Excel DosyalarÄ± (*.xlsx)")
        if file_path:
            success = save_excel(self.df, file_path)
            if success:
                QMessageBox.information(self, "BaÅŸarÄ±lÄ±", "Excel dosyasÄ± kaydedildi.")
            else:
                QMessageBox.critical(self, "Hata", "Excel dosyasÄ± kaydedilemedi.")

    def save_current_file(self):
        """(GeÃ§erli sekmedeki verileri kaydeden fonksiyon).
        EÄŸer sekme yoksa iÅŸlemi durdurur."""
        current_tab_index = self.tab_widget.currentIndex()
        if current_tab_index == -1:
            return

        current_tab_name = self.tab_widget.tabText(current_tab_index)
        context = self.tab_contexts.get(current_tab_name)

        if 'context':
            file_path = context['file_path']
            df = context['df']
            success = save_excel(df, file_path)

            for log_entry in self.log_lines:
                if success:
                    log_entry(is_filepath=file_path, title=file_path, log_entry_is_saved=True)
            self.save_log_lines_to_log_file()
            context['last_saved_df'] = df.copy()
        else:
            QMessageBox.critical(self, "Hata", "Excel dosyasÄ± kaydedilemedi.")

    def update_cell_value(self):
        """
        SeÃ§ili hÃ¼credeki deÄŸeri gÃ¼ncelleyen fonksiyon.
        KullanÄ±cÄ±nÄ±n girdiÄŸi yeni metni DataFrame'e kaydeder ve tabloyu gÃ¼nceller.
        """
        if self.selected_row is None and self.selected_column is None:
            return

        current_tab_index = self.tab_widget.currentIndex()
        if current_tab_index == -1:
            return

        current_tab_name = self.tab_widget.tabText(current_tab_index)
        context = self.tab_contexts.get(current_tab_name)

        df = context['df']
        temp_df = df.copy()
        table_view = context['table_view']
        data_model = context['data_model']
        cell_edit_input = context['cell_edit_input']

        new_text = cell_edit_input.text()

        column_name = data_model.headerData(self.selected_column, Qt.Orientation.Horizontal)
        
        if column_name in df.columns and self.selected_row < len(df):
            df.loc[self.selected_row, column_name] = new_text
            self.apply_changes(temp_df, change_type="DeÄŸiÅŸtir")
        
    def open_details_window(self, row_index):
        """
        SeÃ§ili satÄ±rÄ±n ayrÄ±ntÄ±larÄ±nÄ± gÃ¶steren bir pencere aÃ§an fonksiyon.

        Args:
            row_index (int): AyrÄ±ntÄ±larÄ± gÃ¶sterilecek satÄ±rÄ±n indeksi.
        """
        tab_name = self.tab_widget.tabText(self.tab_widget.currentIndex())
        context = self.tab_contexts.get(tab_name)

        if not context:
            return

        df = context["df"]
        temp_df = df.copy()
        table = context['table_view']
        headers = list(df.columns)
        row_data = df.iloc[row_index].tolist()
        details_window = DetailsWindow(headers, row_data, row_index, df, table, self)
        details_window.exec()
        self.apply_changes(temp_df, change_type="DeÄŸiÅŸtir")

    def delete_row(self, row_index):
        """
        Belirtilen satÄ±rÄ± tablo ve DataFrame'den silen fonksiyon.

        Args:
            row_index (int): Silinecek satÄ±rÄ±n indeksi.
        """
        current_tab_index = self.tab_widget.currentIndex()
        if current_tab_index == -1:
            return

        current_tab_name = self.tab_widget.tabText(current_tab_index)
        context = self.tab_contexts.get(current_tab_name)

        if context:
            df = context['df']
            if row_index < 0 or row_index >= len(df):
                return

            description, ok = QInputDialog.getText(
                self,
                "Silme Sebebi",
                "Malzemeyi silme sebebinizi giriniz:"
            )

            if ok:
                if not description:
                    QMessageBox.warning(self, 'Hata', 'Silme sebebi girilmeden silme iÅŸlemi gerÃ§ekleÅŸtirilemez.')
                    return
            temp_df = df.copy()
            context['df'] = df.drop(index=row_index).reset_index(drop=True)
            self.apply_changes(temp_df, change_type= "Sil", description=description)
        
    def open_add_item_window(self, df, mode="element"):
        """
        Yeni malzeme veya tedarik ekleme penceresini aÃ§ar.
        mode: "element" (Tedarik) veya "material" (Malzeme)
        """
        # KullanÄ±cÄ±dan tip seÃ§mesini iste
        items = ['KonnektÃ¶r', 'Backshell', 'DiÄŸer Malzemeler']
        title = "Tedarik Ekleme" if mode == "element" else "Malzeme Ekleme"
        item_type, ok = QInputDialog.getItem(self, "Malzeme Tipi SeÃ§", 
                                            "LÃ¼tfen girilecek malzemenin tipini seÃ§iniz.", 
                                            items, 0, False)

        if not (ok and item_type):
            return

        # Gerekli hazÄ±rlÄ±klar
        temp_df = df.copy()
        material_options = {}
        if self.json_data:
            options_filepath = self.get_file_path("options_config_filepath")
            material_options = self.load_json_data(options_filepath)

        # DeÄŸiÅŸkenleri hazÄ±rla (default None)
        material_definition = None
        part_number = None
        connector_details = None
        
        # SeÃ§ime gÃ¶re Ã¶n pencereleri aÃ§ (Connector/Backshell tanÄ±mlama)
        if item_type == "KonnektÃ¶r":
            conn_win = ConnectorDefinitionWindow(self)
            conn_win.exec()
            if not conn_win.is_successful: return
            
            material_definition = conn_win.get_created_definition()
            part_number = conn_win.get_part_number()
            connector_details = conn_win.get_connector_details()

        elif item_type == "Backshell":
            back_win = BackshellDefinitionWindow(self)
            back_win.exec()
            if not back_win.is_successful: return

            material_definition = back_win.get_created_definition()
            part_number = back_win.get_part_number()
            # backshell_details varsa buraya eklenebilir

        # Ortak Pencereyi AÃ§ (AddItemWindow)
        # mode parametresini buraya gÃ¶nderiyoruz ("element" veya "material")
        add_window = AddItemWindow(
            df=df, 
            table=self.table_view, # EÄŸer table_view o anki contexte gÃ¶re dinamik deÄŸilse self.current_context.table_view kullanÄ±n
            parent=self, 
            material_options=material_options, 
            material_definition=material_definition, 
            part_number=part_number, 
            connector_details=connector_details,
            mode=mode 
        )
        
        add_window.exec()

        if add_window.is_successful:
             self.apply_changes(temp_df, change_type="Ekle")
    

    def open_edit_storage_amount_window(self, df, row_index):
        """
        Depodaki malzeme miktarÄ±nÄ± dÃ¼zenlemek iÃ§in pencere aÃ§an fonksiyon.

        Args:
            df (pd.DataFrame): Malzeme bilgilerini iÃ§eren DataFrame.
            row_index (int): DÃ¼zenlenecek malzemenin satÄ±r indeksi.
        """
        temp_df = df.copy()
        edit_storage_amount_window = EditStorageAmountWindow(df, row_index, self)
        edit_storage_amount_window.exec()
        self.apply_changes(temp_df, change_type="Kalan adet duzenle", description=edit_storage_amount_window.description)
    
    
    def open_material_log_window(self, df, row_index):
        current_tab_index = self.tab_widget.currentIndex()
        if current_tab_index == -1:
            return

        current_tab_name = self.tab_widget.tabText(current_tab_index)
        context = self.tab_contexts.get(current_tab_name)

        if context:
            df = context['df']
            if row_index < 0 or row_index >= len(df):
                return

            material_description = df.at[row_index, "Malzeme Katalog TanÄ±mÄ± (TR)"]

            filtered_lines = []
            for log_line in self.log_lines:
                line = log_line["log_line"]
                if material_description in line:
                    filtered_lines.append(log_line)

            self.show_log_for_a_specific_item(filtered_lines)


    def on_category_changed(self, selected_category, do_not_update=False):
        current_tab_index = self.tab_widget.currentIndex()
        current_file_name = self.tab_widget.tabText(current_tab_index)
        tab_context = self.tab_contexts.get(current_file_name)

        if not tab_context:
            return

        proxy_model = tab_context['proxy_model']
        df = tab_context['df']
        
        # VarsayÄ±lan baÅŸlÄ±klarÄ± JSON config'den al
        if self.json_data and selected_category in self.json_data:
            base_headers = list(self.json_data[selected_category])
        else:
            base_headers = df.columns.tolist()

        final_headers = []

        if selected_category == "KonnektÃ¶rler":
            json_col_name = "KonnektÃ¶r DetaylarÄ± (JSON)"
            
            # TÃ¼m satÄ±rlardaki JSON verilerini tarayÄ±p benzersiz anahtarlarÄ± bul
            all_json_keys = set()
            if json_col_name in df.columns:
                for json_string in df[json_col_name].dropna():
                    if json_string and str(json_string).lower() != 'nan':
                        try:
                            json_data = json.loads(str(json_string))
                            all_json_keys.update(json_data.keys())
                        except json.JSONDecodeError:
                            pass
            
            sorted_json_keys = sorted(list(all_json_keys))
            
            # BaÅŸlÄ±k sÄ±rasÄ±nÄ± belirle: [Sabit BaÅŸlÄ±klar] + [JSON Keyleri] + [DiÄŸerleri...]
            # Ã–rneÄŸin "Malzeme Katalog TanÄ±mÄ± (TR)" en baÅŸa, sonra JSON verileri gelsin.
            
            priority_headers = ["Malzeme Katalog TanÄ±mÄ± (TR)"]
            end_headers = ["ParÃ§a No", "Depo MiktarÄ±", "Depo Konumu", "Durum", "Ä°ÅŸlemler"]
            
            # Priority headers listeye ekle
            for h in priority_headers:
                if h in df.columns or h in base_headers:
                    final_headers.append(h)
            
            # JSON keylerini ekle (Sanal SÃ¼tunlar)
            final_headers.extend(sorted_json_keys)
            
            # Sonda gÃ¶rÃ¼nmesini istediklerini ekle (eÄŸer base_headers iÃ§indeyse)
            for h in base_headers:
                if h not in final_headers and h not in end_headers:
                     # config dosyasÄ±nda tanÄ±mlÄ± ama priority veya json deÄŸilse ekle
                    final_headers.append(h)

            for h in end_headers:
                 # Config dosyasÄ±nda varsa ve henÃ¼z eklenmediyse ekle
                 if h in base_headers and h not in final_headers:
                     final_headers.append(h)
                     
            if "Ä°ÅŸlemler" not in final_headers:
                final_headers.append("Ä°ÅŸlemler")

        else:
            # DiÄŸer kategoriler iÃ§in standart davranÄ±ÅŸ
            final_headers = base_headers + ["Ä°ÅŸlemler"]

        # Proxy model'e yeni sÃ¼tun listesini ve kategoriyi bildir
        tab_context["headers"] = final_headers.copy()
        proxy_model.setColumnFilter(final_headers)
        proxy_model.setCategoryFilter(selected_category)

        if not do_not_update:
            self.update_row_filters()
        self.refresh_action_delegate()


    def closeEvent(self, event):
        """
        Pencere kapatÄ±ldÄ±ÄŸÄ±nda Ã§aÄŸrÄ±lan olay iÅŸleyici.

        Args:
            event: Kapatma olayÄ±.
        """
        self.on_close(event)
        # event.accept()

    def show_log_for_all_items(self):
        log_entries = self.log_lines
        is_light = self.current_theme == "light"
        log_window = LogWindow(log_entries, is_light, self.log_filepath, self)
        log_window.exec()

    def show_log_for_a_specific_item(self, log_entries):
        is_light = self.current_theme == "light"
        log_window = LogWindow(log_entries, is_light, self.log_filepath, self)
        log_window.exec()

    def on_close(self, event):
        """
        Pencere kapatÄ±lmadan Ã¶nce kaydedilmemiÅŸ dosyalarÄ± kontrol eden fonksiyon.

        Args:
            event: Kapatma olayÄ±.
        """
        unsaved_files = []
        for tab_name, context in self.tab_contexts.items():
            if not context['df'].equals(context['last_saved_df']):
                unsaved_files.append(tab_name)


        if unsaved_files:
            unsaved_files_str = "\n".join(unsaved_files)
            reply = QMessageBox.question(self, "UyarÄ±",
                                    f"AÅŸaÄŸÄ±daki dosyalar kaydedilmemiÅŸ:\n\n{unsaved_files_str}\n\nKaydet ve kapat?",
                                    QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No | QMessageBox.StandardButton.Cancel)

            if reply == QMessageBox.StandardButton.Yes:
                for tab_name in unsaved_files:
                    context = self.tab_contexts.get(tab_name)
                    if context:
                        file_path = context['file_path']
                        df = context['df']
                        success = save_excel(df, file_path)
                        if success:
                            for log_entry in self.log_lines:
                                if log_entry['file_path'] == file_path:
                                    log_entry['is_saved'] = True

                            self.save_log_lines_to_file()
                            context['last_saved_df'] = df.copy()
                        else:
                            QMessageBox.critical(self, "Hata", f"{tab_name} dosyasÄ± kaydedilemedi.")
                            event.accept()
                            return

                event.accept()
            elif reply == QMessageBox.StandardButton.No:
                event.accept()
            elif reply == QMessageBox.StandardButton.Cancel:
                event.ignore()
            else:
                event.accept()

    def undo_changes(self):
        """
        Son yapÄ±lan deÄŸiÅŸiklikleri geri alÄ±r.

        Mevcut sekmedeki verileri, son deÄŸiÅŸikliklerin yapÄ±ldÄ±ÄŸÄ± veri Ã§erÃ§evesi ile karÅŸÄ±laÅŸtÄ±rÄ±r.
        EÄŸer son deÄŸiÅŸiklik bulunamazsa, kullanÄ±cÄ±ya bir uyarÄ± mesajÄ± gÃ¶sterir.
        Aksi takdirde, veri Ã§erÃ§evesini son deÄŸiÅŸikliklerin yapÄ±ldÄ±ÄŸÄ± duruma geri dÃ¶ndÃ¼rÃ¼r.
        """

        current_tab_index = self.tab_widget.currentIndex()
        current_tab_name = self.tab_widget.tabText(current_tab_index)

        tab_context = self.tab_contexts.get(current_tab_name)

        if tab_context:
            history_index = tab_context.get('history_index')
            undo_history = tab_context.get('undo_history')

        if history_index <= 0:
                QMessageBox.warning(self.tab_widget, "UyarÄ±", "Geri alÄ±nacak deÄŸiÅŸiklik bulunmamaktadÄ±r.")
                return
        else:
            change_id_to_remove = self.last_change_id
            for log_entry in self.log_lines:
                if log_entry.get('change_id') == change_id_to_remove:
                    log_entry['is_active'] = False
            new_index = history_index - 1
            restored_df = undo_history[history_index]
            tab_context['df'] = restored_df.copy()
            tab_context['history_index'] = new_index
            self.update_table_from_df(change_type="Undo")

    def redo_changes(self):
        # Son geri alÄ±nan deÄŸiÅŸiklikleri yeniden uygular.
        # Mevcut sekmedeki verileri, geri alÄ±nan son deÄŸiÅŸikliklere geri dÃ¶ndÃ¼rÃ¼r.
        # EÄŸer yeniden uygulanacak deÄŸiÅŸiklik yoksa, kullanÄ±cÄ±ya bir uyarÄ± mesajÄ± gÃ¶sterir.
        current_tab_index = self.tab_widget.currentIndex()
        current_tab_name = self.tab_widget.tabText(current_tab_index)
        
        tab_context = self.tab_contexts.get(current_tab_name)
        
        if tab_context:
            history_index = tab_context.get('history_index')
            undo_history = tab_context.get('undo_history')

            if history_index + 2 >= len(undo_history):
                QMessageBox.warning(self.tab_widget, "UyarÄ±", "Yeniden uygulanacak deÄŸiÅŸiklik bulunmamaktadÄ±r.")
                return

            else:
                change_id_to_active = self.last_change_id + 1
                for log_entry in self.log_lines:
                    if log_entry.get('change_id') == change_id_to_active:
                        log_entry['is_active'] = True
                new_index = history_index + 2
                restored_df = undo_history[new_index]
                tab_context['df'] = restored_df.copy()
                tab_context['history_index']= new_index -1
                self.update_table_from_df(change_type="Redo")

    def apply_changes(self, temp_df, change_type, description=""):
        current_tab_index = self.tab_widget.currentIndex()
        current_tab_name = self.tab_widget.tabText(current_tab_index)
        tab_context = self.tab_contexts.get(current_tab_name)

        if tab_context:
            if not tab_context['df'].equals(temp_df):
                self.last_change_id += 1
                change_id = self.last_change_id
                if tab_context['history_index'] <= len(tab_context['undo_history']) - 1:
                    tab_context['undo_history'] = tab_context['undo_history'][:tab_context['history_index'] + 1]
                    tab_context['undo_history'].append(temp_df.copy())
                    tab_context['history_index'] = len(tab_context['undo_history']) - 1

                self.apply_log(tab_context, temp_df, tab_context['df'], change_type, description, change_id)

                while len(tab_context['undo_history']) > self.MAX_UNDO_STEPS:
                    tab_context['undo_history'].pop(0)
                    tab_context['history_index'] -= 1
                self.update_table_from_df(change_type=change_type)

    def apply_log(self, tab_context, old_df, new_df, change_type="", description="", change_id=None):
        if tab_context["has_valid_headers"]:
            save_log = True
            log_string = ""
            if change_type == "Ekle":
                definition = find_extra_row_value(old_df, new_df)
                if definition is None or definition == "":
                    save_log = False
                else:
                    log_string += "&||/" + "Yeni malzeme eklendi"
                    log_string += "&||/" + "Eklenen malzeme: " + definition
            elif change_type == "degistir":
                definition, before, after = get_definition_and_changes(old_df, new_df)
                if definition is None or definition == "":
                    save_log = False
                else:
                    log_string += "&||/" + "Bir malzemenin Ã¶zellikleri gÃ¼ncellendi"
                    log_string += "&||/" + "Malzeme: " + definition
                    for attr, old_value, new_value in zip(before.keys(), before.values(), after.values()):
                        log_string += f"&||/{attr}: \"{old_value}\" -> \"{new_value}\""
            elif change_type == "Sil":
                definition = find_extra_row_value(new_df, old_df)
                if definition is None or definition == "":
                    save_log = False
                else:
                    log_string += "&||/" + "Bir malzeme silindi"
                    log_string += "&||/" + "Silinen Malzeme: " + definition
            elif change_type == "Depoya ekle":
                definition, _, after = get_definition_and_changes(old_df, new_df)
                if definition is None or definition == "":
                    save_log = False
                else:
                    log_string += "&||/" + "Bir malzeme depoya eklendi"
                    log_string += "&||/" + "Malzeme: " + definition
                    log_string += "&||/" + "DeÄŸerler: " + str(after)
            elif change_type == "Kalan adet duzenle":
                definition, before, after = get_definition_and_changes(old_df, new_df)
                if definition is None or definition == "":
                    save_log = False
                else:
                    log_string += "&||/" + "Bir malzemenin sayÄ±sÄ± gÃ¼ncellendi"
                    log_string += "&||/" + "Malzeme: " + definition
                    for attr, old_value, new_value in zip(before.keys(), before.values(), after.values()):
                            log_string += f"&||/{attr}: \"{old_value}\" -> \"{new_value}\""
            elif change_type == "Procedures":
                definition, before, after = get_definition_and_changes(old_df, new_df)
                if definition is None or definition == "":
                    save_log = False
                else:
                    log_string += "&||/" + "ProsedÃ¼r uygulandÄ±"
                    log_string += "&||/" + "Malzeme: " + definition
                    for attr, old_value, new_value in zip(before.keys(), before.values(), after.values()):
                        log_string += f"&||/{attr}: \"{old_value}\" -> \"{new_value}\""
            elif change_type == "Ekipman Atama":
                definition, before, after = get_definition_and_changes(old_df, new_df)
                if definition is None or definition == "":
                    save_log = False
                else:
                    log_string += "&||/" + "Ekipman atamasÄ± yapÄ±ldÄ±."
                    log_string += "&||/" + "Malzeme: " + definition
                    for attr, old_value, new_value in zip(before.keys(), before.values(), after.values()):
                        log_string += f"&||/{attr}: \"{old_value}\" -> \"{new_value}\""
            elif change_type == "Undo" | change_type == "Redo":
                save_log = True
            else:
                save_log = False

            if save_log:
                if description != "":
                    log_string += "&||/" + "AÃ§Ä±klama: " + description
                
                self.add_log_line(log_string, tab_context['file_path'], change_id)


    def increase_screen_size(self):
        current_width = self.width()
        current_height = self.height()
        new_width = int(current_width * 1.25)
        new_height = int(current_height * 1.25)
        self.resize(new_width, new_height)

    def decrease_screen_size(self):
        current_width = self.width()
        current_height = self.height()
        new_width = int(current_width * 0.75)
        new_height = int(current_height * 0.75)
        self.resize(new_width, new_height)

    def add_log_line(self, message, filepath, change_id=None):
        current_time = datetime.now()
        timestamp = current_time.strftime("[%d.%m.%Y %H:%M]")
        formatted_message = f"{timestamp} - {filepath} {message}"
        self.log_lines.append({"log_line": formatted_message, "is_saved": False, "filepath": filepath, "change_id": change_id, "is_active": True})#hatalÄ±n bÃ¼yÃ¼k ihtimalle is_active

    def save_log_lines_to_log_file(self):
        if self.log_filepath is None:
            pass
        else:
            try:
                with open(self.log_filepath, 'w', encoding='utf-8') as file:
                    for log_entry in self.log_lines:
                        if log_entry["is_saved"] & log_entry["is_active"]:
                            file.write(f"{log_entry['log_line']}\n")
            except Exception as e:
                QMessageBox.critical(self, "Hata", f"Log dosyasÄ± kaydedilemedi: {str(e)}")

    def load_file_paths(self, config_file):
        """JSON dosyasÄ±ndan dosya yollarÄ±nÄ± yÃ¼kler."""
        try:
            with open(config_file, 'r') as file:
                config = json.load(file)
                return config
        except Exception as e:
            QMessageBox.warning(self, "UyarÄ±", f"Dosya yollarÄ±nÄ± belirten JSON dosyasÄ± okunamadÄ±:\n{str(e)}\nBu durumda hea")
            return None

    def get_file_path(self, key):
        """Verilen anahtar iÃ§in dosya yolunu dÃ¶ndÃ¼rÃ¼r."""
        if key in self.file_paths:
            file_path = self.file_paths[key]
            return os.path.abspath(file_path) if not os.path.isabs(file_path) else file_path
        else:
            raise KeyError(f"{key} not found in the configuration.")

    def get_draft_filepath(self, original_filepath):
        directory = os.path.dirname(original_filepath)
        filename_with_ext = os.path.basename(original_filepath)
        filename, ext = os.path.splitext(filename_with_ext)
        draft_filename = f".{filename}_draft{ext}"
        return os.path.join(directory, draft_filename)

    def auto_save_all_tabs(self):
        saved_count = 0
        for tab_name, context in self.tab_contexts.items():
            df = context.get('df')
            last_saved_df = context.get('last_saved_df')
            file_path = context['file_path']
            draft_filepath = self.get_draft_filepath(file_path)

            if df is not None and last_saved_df is not None and not df.equals(last_saved_df):
                if draft_filepath:
                    success = save_excel(df, draft_filepath)
                    if success:
                        saved_count += 1
            if saved_count > 0:
                pass

    def open_asset_assignment_window(self, row_index):
        current_tab_name = self.tab_widget.tabText(self.tab_widget.currentIndex())
        context = self.tab_contexts.get(current_tab_name)
        if not context: return

        df = context['df']
        temp_df = df.copy()

        assignment_window = AssetAssignmentWindow(df, row_index, self)
        assignment_window.exec()
        self.apply_changes(temp_df, change_type="Ekipman Atama", description="Ekipman atamasÄ± yapÄ±ldÄ±.")

    def update_row_filters(self):
        current_tab= self.tab_widget.tabText(self.tab_widget.currentIndex())
        context = self.tab_contexts.get(current_tab)

        if not context:
            return
        proxy_model = context['proxy_model']
        search_bar = context['search']

        proxy_model.setSearchQuery(search_bar.text())


    def handle_action_click(self, proxy_index, action_name):
        """Delegate'ten gelen tÄ±klama sinyalini iÅŸler."""
        
        # 1. Proxy Index'i GerÃ§ek Veri Ä°ndeksine (Source Index) Ã§evir
        current_tab_name = self.tab_widget.tabText(self.tab_widget.currentIndex())
        context = self.tab_contexts.get(current_tab_name)
        if not context: return
        
        proxy_model = context['proxy_model']
        
        # 0. sÃ¼tun Ã¼zerinden mapToSource yaparak satÄ±rÄ± buluyoruz (En gÃ¼venli yol)
        proxy_row_ref = proxy_model.index(proxy_index.row(), 0)
        source_index = proxy_model.mapToSource(proxy_row_ref)
        
        if not source_index.isValid():
            return
            
        real_row_index = source_index.row()
        df = context['df']

        # 2. Hangi butona tÄ±klandÄ±ysa o iÅŸlemi yap
        if action_name == "details":
            self.open_details_window(real_row_index)
            
        elif action_name == "procedures":
            self.handle_procedures(df, real_row_index)
            
        elif action_name == "edit_storage":
            # Eski kodunuzdaki enable/disable kontrolÃ¼ buraya taÅŸÄ±nabilir
            depo_miktar = str(df.iloc[real_row_index].get("Depo MiktarÄ±", ""))
            depo_konumu = str(df.iloc[real_row_index].get("Depo Konumu", ""))
            
            if depo_miktar or depo_konumu:
                self.open_edit_storage_amount_window(df, real_row_index)
            else:
                QMessageBox.warning(self, "UyarÄ±", "Depo bilgisi olmayan malzeme dÃ¼zenlenemez.")
                
        elif action_name == "log":
            self.open_material_log_window(df, real_row_index)
            
        elif action_name == "assign":
            self.open_asset_assignment_window(real_row_index)
            
        elif action_name == "delete":
            self.delete_row(real_row_index)

    def refresh_action_delegate(self):
        """
        GeÃ§erli sekmedeki 'Ä°ÅŸlemler' sÃ¼tununu bulur ve ActionButtonsDelegate'i atar.
        Ã–nceki delegate atamalarÄ±nÄ± temizler.
        """
        current_tab_name = self.tab_widget.tabText(self.tab_widget.currentIndex())
        tab_context = self.tab_contexts.get(current_tab_name)
        
        if not tab_context:
            return

        table_view = tab_context.get('table_view')
        proxy_model = tab_context.get('proxy_model')

        # --- KRÄ°TÄ°K ADIM: Ã–nceki tÃ¼m sÃ¼tunlardaki Delegate'leri temizle ---
        # Bunu yapmazsak, sÃ¼tunlarÄ±n yeri deÄŸiÅŸtiÄŸinde eski sÃ¼tunda butonlar kalÄ±r.
        for col in range(proxy_model.columnCount()):
            table_view.setItemDelegateForColumn(col, None)
        # ------------------------------------------------------------------

        # 1. 'Ä°ÅŸlemler' sÃ¼tununun indeksini bul
        action_col_index = -1
        for col in range(proxy_model.columnCount()):
            header_text = proxy_model.headerData(col, Qt.Orientation.Horizontal)
            if header_text == "Ä°ÅŸlemler":
                action_col_index = col
                break
        
        # 2. Delegate'i ata
        if action_col_index != -1:
            new_delegate = ActionButtonsDelegate(table_view)
            new_delegate.buttonClicked.connect(self.handle_action_click)
            
            # Garbage collection'Ä± Ã¶nlemek iÃ§in context iÃ§inde sakla
            tab_context['active_delegate'] = new_delegate
            
            # Tabloya ata
            table_view.setItemDelegateForColumn(action_col_index, new_delegate)
            
            # SÃ¼tun geniÅŸliÄŸini delegate'in sizeHint'ine gÃ¶re ayarla
            hint_size = new_delegate.sizeHint(None, None)
            table_view.setColumnWidth(action_col_index, hint_size.width())
            
            # Mouse takibini aÃ§
            table_view.setMouseTracking(True)
            table_view.viewport().update()

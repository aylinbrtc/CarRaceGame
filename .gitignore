### IntelliJ IDEA ###
out/
!**/src/main/**/out/
!**/src/test/**/out/

### Eclipse ###
.apt_generated
.classpath
.factorypath
.project
.settings
.springBeans
.sts4-cache
bin/
!**/src/main/**/bin/
!**/src/test/**/bin/

### NetBeans ###
/nbproject/private/
/nbbuild/
/dist/
/nbdist/
/.nb-gradle/

### VS Code ###
.vscode/

### Mac OS ###
.DS_Store


# Eski utils importlarını kaldırın, yerine bunu ekleyin:
from utils.FileOperations import FileOperations
from utils.LoadingThread import FileLoaderThread # Thread dosyasını nereye koyduysanız


def open_default_file(self, file_path):
        if not file_path: return

        # 1. Draft Kontrolü (Main Thread - Hızlı)
        final_path_to_load = file_path
        
        if FileOperations.has_draft(file_path):
            file_name = os.path.basename(file_path)
            reply = QMessageBox.question(
                self, "Taslak Bulundu",
                f"'{file_name}' dosyası için kaydedilmemiş bir taslak var.\nTaslağı yüklemek ister misiniz?",
                QMessageBox.StandardButton.Yes | QMessageBox.StandardButton.No
            )
            if reply == QMessageBox.StandardButton.Yes:
                final_path_to_load = FileOperations.get_draft_path(file_path)
            else:
                FileOperations.delete_draft(file_path) # İstenmeyen taslağı temizle

        # 2. Yükleme Başlat (Loading Göster)
        self.setCursor(Qt.CursorShape.WaitCursor) # Mouse imleci dönsün
        # self.statusBar().showMessage("Dosya yükleniyor, lütfen bekleyin...") 

        # Thread Başlatma
        self.loader = FileLoaderThread(final_path_to_load)
        # Thread bitince on_file_loaded çalışacak, orijinal path'i de gönderiyoruz ki kaydederken oraya kaydetsin
        self.loader.loaded.connect(lambda df: self.on_file_loaded(df, file_path, final_path_to_load))
        self.loader.error.connect(self.on_load_error)
        self.loader.start()

    def select_file(self):
        file_path, _ = QFileDialog.getOpenFileName(self, "Dosya Seç", "", "Excel Dosyaları (*.xlsx *.xls)")
        if file_path:
            # Aynı dosya zaten açıksa uyarı ver (Mevcut mantığınız)
            for existing in self.tab_contexts.values():
                if existing['file_path'] == file_path:
                    QMessageBox.warning(self, "Uyarı", "Bu dosya zaten açık.")
                    return
            
            # Yukarıdaki yeni mantığı kullanması için buraya yönlendiriyoruz
            self.open_default_file(file_path)




def on_file_loaded(self, df, original_path, loaded_path):
        """Thread veri yüklemeyi bitirdiğinde çağrılır."""
        self.setCursor(Qt.CursorShape.ArrowCursor) # İmleci düzelt
        # self.statusBar().showMessage("Yükleme tamamlandı.", 3000)

        if df is None:
            QMessageBox.critical(self, "Hata", "Dosya okunamadı veya veri boş.")
            return

        file_name = os.path.basename(original_path)
        
        # Eğer taslak yüklediysek kullanıcı bilsin
        is_draft = (original_path != loaded_path)
        
        # Temizlik döngülerine gerek yok, df tertemiz geldi. Direkt init_content'e ver.
        self.init_content(file_name, df, original_path)
        
        if is_draft:
            self.tab_widget.setTabText(self.tab_widget.currentIndex(), f"{file_name} * (Taslak)")
            QMessageBox.information(self, "Bilgi", "Kaydedilmemiş taslak yüklendi.")



def on_load_error(self, error_msg):
        self.setCursor(Qt.CursorShape.ArrowCursor)
        QMessageBox.critical(self, "Dosya Açma Hatası", f"Beklenmedik bir hata oluştu:\n{error_msg}")


def save_current_file(self):
        current_idx = self.tab_widget.currentIndex()
        if current_idx == -1: return
        
        tab_name = self.tab_widget.tabText(current_idx)
        # Eğer sekme isminde " * (Taslak)" gibi ekler varsa temizle
        real_tab_name = tab_name.replace(" * (Taslak)", "").strip()
        
        context = self.tab_contexts.get(real_tab_name) # Key'i doğru bulduğuna emin ol
        # Eğer bulamazsa context'i tab_widget.currentWidget() üzerinden bulmayı dene
        
        if context:
            df = context['df']
            file_path = context['file_path']
            
            # --- YENİ KAYIT MANTIĞI ---
            success = FileOperations.save_file(df, file_path, is_draft=False)
            
            if success:
                # Başarılıysa taslağı sil
                FileOperations.delete_draft(file_path)
                context['last_saved_df'] = df.copy()
                
                # Loglama işlemleriniz (Aynen kalabilir)
                # ...
                
                QMessageBox.information(self, "Başarılı", "Dosya kaydedildi.")
                # Sekme adını düzelt (Yıldız varsa sil)
                self.tab_widget.setTabText(current_idx, real_tab_name)
            else:
                QMessageBox.critical(self, "Hata", "Dosya kaydedilemedi!")



open_file_with_draft_check(self, file_path) -> SİL
get_draft_filepath(self, original_filepath) -> SİL
save_to_excel(self) 
